<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Архив - Trading Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/air-datepicker@latest/air-datepicker.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@latest/air-datepicker.js"></script>

    <style>
      .air-datepicker {
        background: rgb(31 41 55);
        border: none;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
      }

      .air-datepicker-nav {
        padding: 10px 0 20px;
        border: none;
      }

      .air-datepicker-nav--title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .air-datepicker-nav--action {
        color: rgb(156 163 175);
        transition: all 0.2s;
        padding: 8px;
        border-radius: 50%;
        background: transparent;
      }

      .air-datepicker-nav--action:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: scale(1.1);
      }

      .air-datepicker-body--day-name {
        color: rgb(156 163 175);
        font-size: 0.875rem;
        font-weight: 500;
      }

      .air-datepicker-cell {
        color: rgb(209 213 219);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 0.9375rem;
        transition: all 0.2s;
      }

      .air-datepicker-cell:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
      }

      .air-datepicker-cell.-selected- {
        background: rgb(59 130 246) !important;
        color: white;
        font-weight: 600;
      }

      .air-datepicker-cell.-current- {
        border: 2px solid rgb(59 130 246);
        color: rgb(59 130 246);
        font-weight: 600;
      }

      .air-datepicker-cell.-in-range- {
        background: rgba(59, 130, 246, 0.2);
        color: white;
        border-radius: 0;
      }
    </style>
  </head>

  <body class="bg-gray-900 text-white">
    <div class="flex min-h-screen">
      <!-- Боковое меню -->
      <div
        class="w-72 bg-gray-800/50 backdrop-blur-lg border-r border-gray-700/50 p-8"
      >
        <div class="mb-8">
          <h1 class="text-xl font-semibold text-white mb-1">Trading Tools</h1>
          <p class="text-sm text-gray-400">Инструменты для трейдинга</p>
        </div>
        <nav class="space-y-1">
          <a
            href="index.html"
            class="flex items-center px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800/50 hover:text-white transition-all duration-200"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
              />
            </svg>
            Калькулятор
          </a>
          <a
            href="profit.html"
            class="flex items-center px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800/50 hover:text-white transition-all duration-200"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            Моя прибыль
          </a>
          <a
            href="archive.html"
            class="flex items-center px-4 py-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
            Архив
          </a>
        </nav>
        <div class="mt-auto pt-8 border-t border-gray-700/50 mt-8">
          <div class="text-xs text-gray-400">Версия 1.0.0</div>
        </div>
      </div>

      <!-- Основной контент -->
      <div class="flex-1 p-8">
        <div class="mb-8">
          <a
            href="profit.html"
            class="text-gray-400 hover:text-white transition-colors"
          >
            ← Вернуться к прибыли
          </a>
        </div>

        <h1 class="text-2xl font-bold mb-8">Архив результатов</h1>

        <!-- Кнопки экспорта/импорта -->
        <div class="flex gap-4 mb-8">
          <button
            id="exportArchive"
            class="py-2 px-4 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors"
          >
            Экспорт архива
          </button>
          <label
            for="importArchive"
            class="py-2 px-4 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors cursor-pointer"
          >
            Импорт архива
          </label>
          <input type="file" id="importArchive" accept=".json" class="hidden" />
        </div>

        <!-- Список архивных недель -->
        <div id="archiveList" class="space-y-4">
          <!-- Здесь будут отображаться архивные записи -->
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const archiveList = document.getElementById("archiveList");
        const exportArchiveBtn = document.getElementById("exportArchive");
        const importArchiveInput = document.getElementById("importArchive");
        const archive = JSON.parse(
          localStorage.getItem("weeklyArchive") || "[]"
        );

        // Функция экспорта архива
        function exportArchive() {
          // Получаем архив из localStorage
          const archive = JSON.parse(
            localStorage.getItem("weeklyArchive") || "[]"
          );

          // Создаем объект с данными архива и метаданными
          const data = {
            archive: archive,
            exportDate: new Date().toISOString(),
            version: "1.0.0",
          };

          // Создаем файл для скачивания
          const dataStr = JSON.stringify(data, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });

          // Создаем ссылку для скачивания
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;

          // Формируем имя файла с текущей датой
          const now = new Date();
          const dateStr = now.toISOString().split("T")[0]; // YYYY-MM-DD
          link.download = `trading-archive-${dateStr}.json`;

          // Запускаем скачивание
          document.body.appendChild(link);
          link.click();

          // Очищаем
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }, 100);
        }

        // Функция импорта архива
        function importArchive(file) {
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);

              // Проверяем структуру данных
              if (!data.archive || !Array.isArray(data.archive)) {
                throw new Error("Неверный формат файла архива");
              }

              // Сохраняем архив в localStorage
              localStorage.setItem(
                "weeklyArchive",
                JSON.stringify(data.archive)
              );

              // Перезагружаем страницу для обновления данных
              location.reload();

              alert("Архив успешно импортирован!");
            } catch (error) {
              console.error("Ошибка при импорте архива:", error);
              alert("Ошибка при импорте архива: " + error.message);
            }
          };

          reader.readAsText(file);
        }

        // Обработчик кнопки экспорта
        exportArchiveBtn.addEventListener("click", exportArchive);

        // Обработчик выбора файла для импорта
        importArchiveInput.addEventListener("change", (e) => {
          if (e.target.files.length > 0) {
            if (
              confirm(
                "Импорт архива заменит все текущие данные архива. Продолжить?"
              )
            ) {
              importArchive(e.target.files[0]);
            }
            // Сбрасываем input, чтобы можно было выбрать тот же файл повторно
            e.target.value = "";
          }
        });

        if (archive.length === 0) {
          archiveList.innerHTML = '<p class="text-gray-400">Архив пуст</p>';
          return;
        }

        // Сортируем недели в обратном порядке (новые сверху)
        archive.reverse().forEach((week, index) => {
          const weekEl = document.createElement("div");
          weekEl.className =
            "bg-gray-800/50 backdrop-blur-sm border border-gray-700/50 rounded-xl p-6";
          weekEl.dataset.index = archive.length - 1 - index; // Сохраняем оригинальный индекс

          // Рассчитываем средний результат
          const nonZeroTrades = week.trades.filter((t) => t && t.value !== 0);
          const averageResult =
            nonZeroTrades.length > 0
              ? nonZeroTrades.reduce(
                  (sum, t) => sum + (Number(t.value) || 0),
                  0
                ) / nonZeroTrades.length
              : 0;

          const resultClass =
            week.totalResult > 0
              ? "text-green-400"
              : week.totalResult < 0
              ? "text-red-400"
              : "text-gray-400";

          weekEl.innerHTML = `
            <div class="flex justify-between items-start mb-4 relative pr-8">
              <div>
                <h3 class="text-lg font-medium">${week.weekStart} - ${
            week.weekEnd
          }</h3>
                <p class="text-sm text-gray-400 mt-1">Всего сделок: ${
                  week.totalTrades
                }</p>
              </div>
              <div class="text-right">
                <div class="text-xl font-bold ${resultClass}">${(
            week.totalResult || 0
          ).toFixed(2)}%</div>
                <div class="text-sm text-gray-400 mt-1">В среднем: ${averageResult.toFixed(
                  2
                )}%</div>
              </div>
              <button class="delete-week absolute top-0 right-0 -mt-3 -mr-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 p-2 rounded-full transition-all shadow-lg">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-700/50">
              ${week.trades
                .map(
                  (trade) => `
                <div class="flex justify-between items-center">
                  <span class="text-gray-400">${trade.day}</span>
                  <span class="${
                    trade.value > 0
                      ? "text-green-400"
                      : trade.value < 0
                      ? "text-red-400"
                      : "text-gray-400"
                  }">
                    ${
                      trade.value !== undefined && trade.value !== null
                        ? Number(trade.value).toFixed(2) + "%"
                        : "-"
                    }
                  </span>
                </div>
              `
                )
                .join("")}
            </div>
          `;

          archiveList.appendChild(weekEl);
        });

        // Добавляем обработчики для кнопок удаления
        document.querySelectorAll(".delete-week").forEach((button) => {
          button.addEventListener("click", function (e) {
            e.stopPropagation();
            const weekEl = this.closest("div[data-index]");
            const index = parseInt(weekEl.dataset.index);

            if (
              confirm("Вы уверены, что хотите удалить эту неделю из архива?")
            ) {
              // Получаем архив
              const archive = JSON.parse(
                localStorage.getItem("weeklyArchive") || "[]"
              );

              // Удаляем неделю
              archive.splice(index, 1);

              // Сохраняем обновленный архив
              localStorage.setItem("weeklyArchive", JSON.stringify(archive));

              // Удаляем элемент из DOM
              weekEl.remove();

              // Если архив пуст, показываем сообщение
              if (archive.length === 0) {
                archiveList.innerHTML =
                  '<p class="text-gray-400">Архив пуст</p>';
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
