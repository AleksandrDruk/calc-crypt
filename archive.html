<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Архив прибыли</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/air-datepicker@latest/air-datepicker.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/air-datepicker@latest/air-datepicker.js"></script>

    <style>
      .air-datepicker {
        background: rgb(31 41 55);
        border: none;
        border-radius: 20px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
      }

      .air-datepicker-nav {
        padding: 10px 0 20px;
        border: none;
      }

      .air-datepicker-nav--title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
      }

      .air-datepicker-nav--action {
        color: rgb(156 163 175);
        transition: all 0.2s;
        padding: 8px;
        border-radius: 50%;
        background: transparent;
      }

      .air-datepicker-nav--action:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: scale(1.1);
      }

      .air-datepicker-body--day-name {
        color: rgb(156 163 175);
        font-size: 0.875rem;
        font-weight: 500;
      }

      .air-datepicker-cell {
        color: rgb(209 213 219);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 0.9375rem;
        transition: all 0.2s;
      }

      .air-datepicker-cell:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: scale(1.1);
      }

      .air-datepicker-cell.-selected- {
        background: rgb(59 130 246) !important;
        color: white;
        font-weight: 600;
      }

      .air-datepicker-cell.-current- {
        border: 2px solid rgb(59 130 246);
        color: rgb(59 130 246);
        font-weight: 600;
      }

      .air-datepicker-cell.-in-range- {
        background: rgba(59, 130, 246, 0.2);
        color: white;
        border-radius: 0;
      }
    </style>
  </head>

  <body class="bg-gray-900 text-white">
    <div class="flex min-h-screen">
      <!-- Боковое меню -->
      <div
        class="w-72 bg-gray-800/50 backdrop-blur-lg border-r border-gray-700/50 p-8"
      >
        <div class="mb-8">
          <h1 class="text-xl font-semibold text-white mb-1">Trading Tools</h1>
          <p class="text-sm text-gray-400">Инструменты для трейдинга</p>
        </div>
        <nav class="space-y-1">
          <a
            href="index.html"
            class="flex items-center px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800/50 hover:text-white transition-all duration-200"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
              />
            </svg>
            Калькулятор
          </a>
          <a
            href="profit.html"
            class="flex items-center px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800/50 hover:text-white transition-all duration-200"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
              />
            </svg>
            Моя прибыль
          </a>
          <a
            href="archive.html"
            class="flex items-center px-4 py-3 rounded-xl bg-blue-500/10 text-blue-400 border border-blue-500/20"
          >
            <svg
              class="w-5 h-5 mr-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
            Архив
          </a>
        </nav>
        <div class="mt-auto pt-8 border-t border-gray-700/50 mt-8">
          <div class="text-xs text-gray-400">Версия 1.0.0</div>
        </div>
      </div>

      <!-- Основной контент -->
      <div class="flex-1 p-8">
        <div class="flex justify-between items-start gap-8">
          <!-- Левая часть с итогами -->
          <div class="flex-1">
            <div class="bg-gray-800 rounded-lg p-6">
              <h2 class="text-xl font-semibold mb-4">Итоги за период</h2>
              <div id="periodTotal" class="text-4xl font-bold text-blue-400">
                —
              </div>
            </div>
          </div>

          <!-- Правая часть с календарем -->
          <div class="w-[380px]">
            <div class="rounded-lg p-4">
              <div id="dateRange"></div>
            </div>
          </div>
        </div>

        <!-- Контент архива -->
        <div id="archiveContent" class="mt-8 grid gap-4"></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const periodTotal = document.getElementById("periodTotal");

        // Устанавливаем начальные даты
        const today = new Date();
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

        // Инициализация календаря
        const calendar = new AirDatepicker("#dateRange", {
          locale: {
            days: [
              "Воскресенье",
              "Понедельник",
              "Вторник",
              "Среда",
              "Четверг",
              "Пятница",
              "Суббота",
            ],
            daysShort: ["Вос", "Пон", "Вто", "Сре", "Чет", "Пят", "Суб"],
            daysMin: ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"],
            months: [
              "Январь",
              "Февраль",
              "Март",
              "Апрель",
              "Май",
              "Июнь",
              "Июль",
              "Август",
              "Сентябрь",
              "Октябрь",
              "Ноябрь",
              "Декабрь",
            ],
            monthsShort: [
              "Янв",
              "Фев",
              "Мар",
              "Апр",
              "Май",
              "Июн",
              "Июл",
              "Авг",
              "Сен",
              "Окт",
              "Ноя",
              "Дек",
            ],
            today: "Сегодня",
            clear: "Очистить",
            dateFormat: "dd.MM.yyyy",
            timeFormat: "HH:mm",
            firstDay: 1,
          },
          dateFormat: "dd.MM.yyyy",
          range: true,
          inline: true,
          minDate: new Date(2020, 0, 1),
          maxDate: new Date(),
          selectedDates: [threeMonthsAgo, today],
          onSelect({ date, formattedDate, datepicker }) {
            if (date && date.length === 2) {
              loadArchive(date[0], date[1]);
            }
          },
        });

        function loadArchive(startDate = threeMonthsAgo, endDate = today) {
          try {
            const archiveContent = document.getElementById("archiveContent");
            if (!archiveContent) {
              console.error("Element archiveContent not found");
              return;
            }

            const savedData = JSON.parse(
              localStorage.getItem("profitData") || "{}"
            );
            if (!savedData.rows || !Array.isArray(savedData.rows)) {
              console.log("No data found or invalid data format");
              archiveContent.innerHTML =
                '<div class="text-gray-400">Нет данных для отображения</div>';
              return;
            }

            // Очищаем контент
            archiveContent.innerHTML = "";

            // Фильтруем и группируем данные по неделям
            const filteredData = savedData.rows
              .map((row) => ({
                date: new Date(row.date),
                result: parseFloat(row.result) || 0, // Преобразуем в число
              }))
              .filter((row) => row.date >= startDate && row.date <= endDate);

            // Считаем общий результат за период
            const totalResult = filteredData.reduce(
              (sum, row) => sum + row.result,
              0
            );
            periodTotal.textContent = `${totalResult.toFixed(2)}%`;
            periodTotal.className = `text-4xl font-bold ${
              totalResult > 0
                ? "text-green-400"
                : totalResult < 0
                ? "text-red-400"
                : "text-gray-400"
            }`;

            // Группируем по неделям
            const weeks = {};
            filteredData.forEach((row) => {
              const weekStart = new Date(row.date);
              weekStart.setDate(weekStart.getDate() - weekStart.getDay());
              const weekKey = weekStart.toISOString();

              if (!weeks[weekKey]) {
                weeks[weekKey] = {
                  start: weekStart,
                  entries: [],
                  total: 0,
                };
              }

              weeks[weekKey].entries.push(row);
              weeks[weekKey].total += row.result;
            });

            // Отображаем данные по неделям
            Object.values(weeks)
              .sort((a, b) => b.start - a.start)
              .forEach((week) => {
                const weekDiv = document.createElement("div");
                weekDiv.className = "bg-gray-800 rounded-lg overflow-hidden";

                const startDate = week.start.toLocaleDateString("ru-RU", {
                  day: "2-digit",
                  month: "2-digit",
                });
                const endDate = new Date(week.start);
                endDate.setDate(endDate.getDate() + 6);
                const endDateStr = endDate.toLocaleDateString("ru-RU", {
                  day: "2-digit",
                  month: "2-digit",
                });

                const resultClass =
                  week.total > 0
                    ? "text-green-400"
                    : week.total < 0
                    ? "text-red-400"
                    : "text-gray-400";

                weekDiv.innerHTML = `
                <div class="p-4 border-b border-gray-700">
                  <div class="flex justify-between items-center">
                    <h3 class="font-medium">Неделя ${startDate} - ${endDateStr}</h3>
                    <div class="font-medium ${resultClass}">
                      ${week.total.toFixed(2)}%
                    </div>
                  </div>
                </div>
                <div class="p-4">
                  <table class="w-full">
                    <thead>
                      <tr class="text-sm text-gray-400">
                        <th class="text-left py-2">Дата</th>
                        <th class="text-right py-2">Результат</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${week.entries
                        .sort((a, b) => a.date - b.date)
                        .map((entry) => {
                          const date = entry.date.toLocaleDateString("ru-RU", {
                            day: "2-digit",
                            month: "2-digit",
                          });
                          const resultClass =
                            entry.result > 0
                              ? "text-green-400"
                              : entry.result < 0
                              ? "text-red-400"
                              : "text-gray-400";
                          return `
                            <tr class="border-t border-gray-700">
                              <td class="py-2">${date}</td>
                              <td class="text-right ${resultClass}">
                                ${entry.result.toFixed(2)}%
                              </td>
                            </tr>
                          `;
                        })
                        .join("")}
                    </tbody>
                  </table>
                </div>
              `;

                archiveContent.appendChild(weekDiv);
              });
          } catch (error) {
            console.error("Error in loadArchive:", error);
            const archiveContent = document.getElementById("archiveContent");
            if (archiveContent) {
              archiveContent.innerHTML =
                '<div class="text-red-400">Произошла ошибка при загрузке данных</div>';
            }
          }
        }

        // Загружаем архив при загрузке страницы
        loadArchive();
      });
    </script>
  </body>
</html>
